package Qublog::Schema::Result::TaskLog;
use Moose;
extends qw( Qublog::Schema::Result );

=head1 NAME

Qublog::Schema::Result::TaskLog - task logs attach comments and track task changes

=head1 DESCRIPTION

Each comment and change gets a task log entry.

=head1 SCHEMA

=head2 id

The autogenerated ID field.

=head2 task

The L<Qublog::Schema::Result::Task> that has changed or been commented upon.

=head2 log_type

The type of log entry. This must be create, update, or note.

=head2 created_on

The date of the change.

=head2 comment

This is the L<Qublog::Schema::Result::Comment> describing the change.

=cut

__PACKAGE__->load_components(qw( InflateColumn::DateTime Core ));
__PACKAGE__->table('task_logs');
__PACKAGE__->add_columns(
    id         => { data_type => 'int' },
    task       => { data_type => 'int' },
    log_type   => { data_type => 'text' },
    created_on => { data_type => 'datetime', timezone => 'UTC' },
    comment    => { data_type => 'int' },
);
__PACKAGE__->set_primary_key('id');
__PACKAGE__->belongs_to( task => 'Qublog::Schema::Result::Task' );
__PACKAGE__->belongs_to( comment => 'Qublog::Schema::Result::Comment' );
__PACKAGE__->has_many( task_changes => 'Qublog::Schema::Result::TaskChange', 'task_log' );

=head1 METHOD

=head2 new

Sets the L</created_on> field to the default of right now.

=cut

sub new {
    my ($class, $attrs) = @_;

    $attrs->{created_on} = Qublog::DateTime->now 
        unless defined $attrs->{created_on};

    return $class->next::method($attrs);
}

=head2 fill_related_to

Given a L</log_type> value and the L<Qublog::Schema::Result::Task> that we're commenting on.

=cut

sub fill_related_to {
    my ($self, $log_type, $task) = @_;
    $self->log_type($log_type);
    $self->task($task);
    $self->comment($task->latest_comment);
    return $self;
}

=head1 AUTHOR

Andrew Sterling Hanenkamp, C<< <hanenkamp@cpan.org> >>

=head1 LICENSE

Qublog Personal/Professional Journaling
Copyright (C) 2009  Andrew Sterling Hanenkamp

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

=cut

1;
