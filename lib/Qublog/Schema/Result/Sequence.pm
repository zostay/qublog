package Qublog::Schema::Result::Sequence;
use Moose;

extends qw( Qublog::Schema::ResultSet );

=head1 NAME

Qublog::Schema::Rresult::Sequence - sequences for dumb databases

=head1 DESCRIPTION

To setup the auto-tags that are set on tasks and such, I need a way to track sequences. This facility is kind of primitive at this moment.

=head1 SCHEMA

=head2 id

The autogenerated ID of the sequence.

=head2 last_value

The last value returned by L</next_value> in the sequence.

=cut

__PACKAGE__->load_components(qw( Core ));
__PACKAGE__->table('sequences');
__PACKAGE__->add_columns(
    id         => { data_type => 'int' },
    last_value => { data_type => 'int' },
);
__PACKAGE__->set_primary_key('id');

=head1 METHODS

=head2 next_value

Returns the next value in the sequence. 

If you pass a subroutine reference in as the argument to this method, it will use that subroutine to determine if the next value is acceptable or not. The incremented value will be passed to the passed filter subroutine. If the result of the subroutine is true, the value is returned. If the result is false, the value is incremented again and the subroutine is called again. This will repeat until the subroutine returns a true value.

=cut

sub next_value {
    my ($self, $filter) = @_;
    my $next_value = $self->last_value + 1;

    until (not $filter or $filter->($next_value)) { $next_value++ }
    $self->last_value($next_value);

    return $next_value;
}

=head1 AUTHOR

Andrew Sterling Hanenkamp, C<< <hanenkamp@cpan.org> >>

=head1 LICENSE

Qublog Personal/Professional Journaling
Copyright (C) 2009  Andrew Sterling Hanenkamp

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

=cut

1;
